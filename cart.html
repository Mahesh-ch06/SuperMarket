<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart - FreshMart</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Noto+Sans:wght@400;500;700;900&display=swap">
    <style>
        body {
            font-family: 'Space Grotesk', 'Noto Sans', sans-serif;
        }
        /* Styles for the confirmation modal */
        .confirmation-modal {
            transition: opacity 0.3s ease-in-out;
        }

        /* Custom Toast Notification System */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            min-width: 250px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }

        /* Checkout Modal Styles */
        .checkout-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .checkout-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .checkout-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .checkout-modal.show .checkout-modal-content {
            transform: translateY(0);
        }

        /* Step indicator */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.875rem;
            margin: 0 4px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #6ec88e;
            color: white;
        }

        .step.completed {
            background: #22c55e;
            color: white;
        }

        .step-line {
            width: 32px;
            height: 2px;
            background: #e5e7eb;
            transition: all 0.3s ease;
        }

        .step-line.completed {
            background: #22c55e;
        }

        /* Form step animations */
        .checkout-step {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }

        .checkout-step.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        /* Mobile responsive improvements */
        @media (max-width: 640px) {
            .toast {
                min-width: 200px;
                font-size: 0.8rem;
                padding: 10px 16px;
            }
            
            #toast-container {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
            
            .checkout-modal-content {
                width: 95%;
                margin: 16px;
                max-height: 85vh;
            }
            
            .cart-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .cart-item-info {
                flex-direction: row;
                align-items: center;
                gap: 12px;
            }
            
            .cart-item-controls {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .quantity-controls {
                order: 1;
            }
            
            .item-total {
                order: 2;
                text-align: right;
            }
            
            .remove-button {
                order: 3;
            }
        }

        /* Touch-friendly buttons */
        .touch-button {
            min-height: 44px;
            min-width: 44px;
        }

        /* Improved mobile cart layout */
        .mobile-cart-summary {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            margin: 0 -24px -24px -24px;
        }

        @media (min-width: 640px) {
            .mobile-cart-summary {
                position: static;
                border-top: none;
                margin: 0;
                padding: 0;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6ec88e;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Coupon styles */
        .coupon-applied {
            background: #dcfce7;
            border: 1px solid #22c55e;
            color: #166534;
        }

        /* Payment method styles */
        .payment-method {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-method:hover {
            border-color: #6ec88e;
        }

        .payment-method.selected {
            border-color: #6ec88e;
            background: #f0fdf4;
        }

        .payment-method.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-[#f9fbfa]">

    <div class="relative flex min-h-screen flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-solid border-b-[#eaf0ec] px-4 sm:px-10 py-3">
            <div class="flex items-center justify-between">
                <a href="index.html" class="flex items-center gap-3 text-[#111813]">
                    <div class="size-5">
                        <svg viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4 42.4379C4 42.4379 14.0962 36.0744 24 41.1692C35.0664 46.8624 44 42.2078 44 42.2078L44 7.01134C44 7.01134 35.068 11.6577 24.0031 5.96913C14.0971 0.876274 4 7.27094 4 7.27094L4 42.4379Z" fill="currentColor"></path></svg>
                    </div>
                    <h1 class="text-[#111813] text-lg font-bold tracking-[-0.015em]">FreshMart</h1>
                </a>
                <a href="shop.html" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-xl h-10 px-4 bg-[#6ec88e] hover:bg-green-500 text-[#111813] text-sm font-bold tracking-[0.015em] touch-button">
                    <span class="hidden sm:inline">Continue Shopping</span>
                    <span class="sm:hidden">Shop</span>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1">
            <!-- Cart content will be dynamically inserted here by JavaScript -->
        </main>

        <!-- Footer -->
        <footer class="bg-gray-50 border-t">
            <div class="max-w-7xl mx-auto py-6 sm:py-10 px-4 sm:px-6 lg:px-8 text-center">
                <div class="flex flex-wrap justify-center gap-4 sm:gap-x-12 mb-4 sm:mb-6">
                    <a href="aboutus.html" class="text-sm text-gray-600 hover:text-[#6ec88e] touch-button">About Us</a>
                    <a href="contactus.html" class="text-sm text-gray-600 hover:text-[#6ec88e] touch-button">Contact</a>
                    <a href="#" class="text-sm text-gray-600 hover:text-[#6ec88e] touch-button">Privacy Policy</a>
                    <a href="#" class="text-sm text-gray-600 hover:text-[#6ec88e] touch-button">Terms of Service</a>
                </div>
                <p class="text-sm text-gray-500">Â© 2025 FreshMart. All rights reserved.</p>
            </div>
        </footer>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="confirmation-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform -translate-y-10">
            <p id="confirmation-message" class="text-lg font-medium text-[#111813] mb-4"></p>
            <div class="flex flex-col sm:flex-row justify-center gap-3">
                <button id="confirm-btn" class="flex-1 rounded-xl h-12 px-4 bg-red-600 text-white text-sm font-bold hover:bg-red-700 transition-colors touch-button">Yes</button>
                <button id="cancel-btn" class="flex-1 rounded-xl h-12 px-4 bg-gray-200 text-[#111813] text-sm font-bold hover:bg-gray-300 transition-colors touch-button">No</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="checkout-modal">
        <div class="checkout-modal-content">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Checkout</h2>
                    <button id="close-checkout-modal" class="text-gray-400 hover:text-gray-600 touch-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div id="step1" class="step active">1</div>
                    <div class="step-line" id="line1"></div>
                    <div id="step2" class="step">2</div>
                    <div class="step-line" id="line2"></div>
                    <div id="step3" class="step">3</div>
                    <div class="step-line" id="line3"></div>
                    <div id="step4" class="step">4</div>
                </div>

                <!-- Step 1: Address -->
                <div id="address-step" class="checkout-step active">
                    <h3 class="text-xl font-semibold mb-4">Delivery Address</h3>
                    <form id="address-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                                <input type="text" id="fullName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                <input type="tel" id="phoneNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
                            <textarea id="streetAddress" required rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent" placeholder="House/Flat No., Building, Street"></textarea>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                                <input type="text" id="city" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                                <select id="state" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent">
                                    <option value="">Select State</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">PIN Code *</label>
                                <input type="text" id="pincode" required pattern="[0-9]{6}" maxlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Landmark (Optional)</label>
                            <input type="text" id="landmark" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent" placeholder="Near hospital, school, etc.">
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="bg-[#6ec88e] hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition-colors touch-button">
                                Continue to Coupons
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Coupons -->
                <div id="coupon-step" class="checkout-step">
                    <h3 class="text-xl font-semibold mb-4">Apply Coupon</h3>
                    <div class="space-y-4">
                        <div class="flex gap-3">
                            <input type="text" id="coupon-code" placeholder="Enter coupon code" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#6ec88e] focus:border-transparent">
                            <button id="apply-coupon-btn" class="bg-[#6ec88e] hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-colors touch-button">
                                Apply
                            </button>
                        </div>
                        <div id="coupon-message" class="hidden text-sm"></div>
                        
                        <!-- Available Coupons -->
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-900 mb-3">Available Coupons</h4>
                            <div class="space-y-3">
                                <div class="border border-gray-200 rounded-lg p-3 cursor-pointer hover:border-[#6ec88e] transition-colors coupon-card" data-code="FRESH10">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold text-[#6ec88e]">FRESH10</div>
                                            <div class="text-sm text-gray-600">Get 10% off on orders above â¹500</div>
                                        </div>
                                        <button class="text-[#6ec88e] font-medium text-sm apply-coupon-card">Apply</button>
                                    </div>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-3 cursor-pointer hover:border-[#6ec88e] transition-colors coupon-card" data-code="SAVE50">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold text-[#6ec88e]">SAVE50</div>
                                            <div class="text-sm text-gray-600">Flat â¹50 off on orders above â¹300</div>
                                        </div>
                                        <button class="text-[#6ec88e] font-medium text-sm apply-coupon-card">Apply</button>
                                    </div>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-3 cursor-pointer hover:border-[#6ec88e] transition-colors coupon-card" data-code="WELCOME20">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold text-[#6ec88e]">WELCOME20</div>
                                            <div class="text-sm text-gray-600">20% off for new customers (max â¹100)</div>
                                        </div>
                                        <button class="text-[#6ec88e] font-medium text-sm apply-coupon-card">Apply</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button id="back-to-address" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg transition-colors touch-button">
                                Back
                            </button>
                            <button id="continue-to-payment" class="bg-[#6ec88e] hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition-colors touch-button">
                                Continue to Payment
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Payment -->
                <div id="payment-step" class="checkout-step">
                    <h3 class="text-xl font-semibold mb-4">Payment Method</h3>
                    <div class="space-y-4">
                        <div class="payment-method selected" data-method="cod">
                            <div class="flex items-center">
                                <input type="radio" name="payment" value="cod" checked class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">Cash on Delivery</div>
                                    <div class="text-sm text-gray-600">Pay when your order arrives</div>
                                </div>
                                <div class="text-green-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H4.5m2.25 0v3m0 0v.75A.75.75 0 016 10.5h-.75m0 0V9.75c0-.621.504-1.125 1.125-1.125H7.5m0 0v.375c0 .621-.504 1.125-1.125 1.125H6.75m0 0V12m0 0v.75A.75.75 0 016 13.5h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H7.5m0 0V12m0 0v.375c0 .621-.504 1.125-1.125 1.125H6.75m0 0v.75A.75.75 0 006 15h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H7.5m0 0v.375c0 .621-.504 1.125-1.125 1.125H6.75m0 0V15m0 0v.75A.75.75 0 006 16.5h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H7.5" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-method disabled" data-method="online">
                            <div class="flex items-center">
                                <input type="radio" name="payment" value="online" disabled class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">Online Payment</div>
                                    <div class="text-sm text-gray-600">UPI, Cards, Net Banking</div>
                                    <div class="text-xs text-orange-600 mt-1">Coming Soon!</div>
                                </div>
                                <div class="text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="payment-method disabled" data-method="wallet">
                            <div class="flex items-center">
                                <input type="radio" name="payment" value="wallet" disabled class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">Digital Wallet</div>
                                    <div class="text-sm text-gray-600">Paytm, PhonePe, Google Pay</div>
                                    <div class="text-xs text-orange-600 mt-1">Coming Soon!</div>
                                </div>
                                <div class="text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button id="back-to-coupon" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg transition-colors touch-button">
                                Back
                            </button>
                            <button id="continue-to-review" class="bg-[#6ec88e] hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition-colors touch-button">
                                Review Order
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review & Place Order -->
                <div id="review-step" class="checkout-step">
                    <h3 class="text-xl font-semibold mb-4">Review Your Order</h3>
                    <div class="space-y-6">
                        <!-- Order Summary -->
                        <div id="order-summary" class="bg-gray-50 rounded-lg p-4">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <!-- Address Summary -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">Delivery Address</h4>
                            <div id="address-summary" class="text-sm text-gray-600">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Payment Summary -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">Payment Method</h4>
                            <div id="payment-summary" class="text-sm text-gray-600">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Price Breakdown -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Price Details</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Subtotal</span>
                                    <span id="review-subtotal">â¹0.00</span>
                                </div>
                                <div class="flex justify-between text-green-600" id="discount-row" style="display: none;">
                                    <span>Discount</span>
                                    <span id="review-discount">-â¹0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Delivery Fee</span>
                                    <span id="review-delivery">â¹0.00</span>
                                </div>
                                <hr>
                                <div class="flex justify-between font-semibold text-lg">
                                    <span>Total</span>
                                    <span id="review-total">â¹0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button id="back-to-payment" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg transition-colors touch-button">
                                Back
                            </button>
                            <button id="place-order-btn" class="bg-[#6ec88e] hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg transition-colors touch-button">
                                <span>Place Order</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyD1iij4QWlxQJJPS-yJrhSiCS79kS4dqaM",
        authDomain: "portfolio-56be7.firebaseapp.com",
        projectId: "portfolio-56be7",
        storageBucket: "portfolio-56be7.firebasestorage.app",
        messagingSenderId: "888511551571",
        appId: "1:888511551571:web:11e809e995377e9a4ccea6",
        measurementId: "G-X3CYL9YZR1"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUser = null; // To store the authenticated user

    document.addEventListener('DOMContentLoaded', () => {
        let cartItems = [];
        let appliedCoupon = null;
        let checkoutData = {
            address: {},
            paymentMethod: 'cod',
            coupon: null
        };

        const mainContent = document.getElementById('main-content');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const modalContentElement = confirmationModal.querySelector('div');
        const checkoutModal = document.getElementById('checkout-modal');
        
        let actionToConfirm = null;

        // --- Toast Notification System ---
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, type = 'info', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.parentNode?.removeChild(toast), 300);
            }, duration);
        }

        // --- Coupon System ---
        const coupons = {
            'FRESH10': { type: 'percentage', value: 10, minOrder: 500, description: '10% off on orders above â¹500' },
            'SAVE50': { type: 'fixed', value: 50, minOrder: 300, description: 'Flat â¹50 off on orders above â¹300' },
            'WELCOME20': { type: 'percentage', value: 20, minOrder: 200, maxDiscount: 100, description: '20% off for new customers (max â¹100)' }
        };

        function applyCoupon(code, subtotal) {
            const coupon = coupons[code.toUpperCase()];
            if (!coupon) {
                return { success: false, message: 'Invalid coupon code' };
            }

            if (subtotal < coupon.minOrder) {
                return { success: false, message: `Minimum order amount â¹${coupon.minOrder} required` };
            }

            let discount = 0;
            if (coupon.type === 'percentage') {
                discount = (subtotal * coupon.value) / 100;
                if (coupon.maxDiscount) {
                    discount = Math.min(discount, coupon.maxDiscount);
                }
            } else {
                discount = coupon.value;
            }

            return {
                success: true,
                discount: discount,
                coupon: coupon,
                message: `Coupon applied! You saved â¹${discount.toFixed(2)}`
            };
        }

        // Helper to open the confirmation modal with animation
        function openConfirmationModal(message, onConfirmCallback) {
            confirmationMessage.textContent = message;
            actionToConfirm = onConfirmCallback;
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                confirmationModal.classList.remove('opacity-0');
                modalContentElement.classList.remove('-translate-y-10');
            }, 10);
        }

        // Helper to close the confirmation modal with animation
        function closeConfirmationModal() {
            confirmationModal.classList.add('opacity-0');
            modalContentElement.classList.add('-translate-y-10');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                actionToConfirm = null;
            }, 300);
        }

        // --- Checkout Modal Functions ---
        function openCheckoutModal() {
            checkoutModal.classList.add('show');
            document.body.style.overflow = 'hidden';
            populateUserData();
        }

        function closeCheckoutModal() {
            checkoutModal.classList.remove('show');
            document.body.style.overflow = '';
            resetCheckoutSteps();
        }

        function populateUserData() {
            if (currentUser) {
                document.getElementById('fullName').value = currentUser.displayName || '';
                // You can populate other fields from user profile if available
            }
        }

        function resetCheckoutSteps() {
            // Reset to step 1
            goToStep(1);
            // Clear forms
            document.getElementById('address-form').reset();
            document.getElementById('coupon-code').value = '';
            appliedCoupon = null;
            updateCouponDisplay();
        }

        function goToStep(stepNumber) {
            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                const line = document.getElementById(`line${i}`);
                
                if (i < stepNumber) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                    if (line) line.classList.add('completed');
                } else if (i === stepNumber) {
                    step.classList.remove('completed');
                    step.classList.add('active');
                    if (line) line.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                    if (line) line.classList.remove('completed');
                }
            }

            // Show/hide step content
            document.querySelectorAll('.checkout-step').forEach(step => {
                step.classList.remove('active');
            });

            const stepNames = ['', 'address-step', 'coupon-step', 'payment-step', 'review-step'];
            const currentStep = document.getElementById(stepNames[stepNumber]);
            if (currentStep) {
                setTimeout(() => {
                    currentStep.classList.add('active');
                }, 100);
            }

            // Update review step if we're on step 4
            if (stepNumber === 4) {
                updateReviewStep();
            }
        }

        function updateCouponDisplay() {
            const messageEl = document.getElementById('coupon-message');
            const codeInput = document.getElementById('coupon-code');
            
            if (appliedCoupon) {
                messageEl.textContent = appliedCoupon.message;
                messageEl.className = 'text-sm text-green-600 coupon-applied p-2 rounded';
                messageEl.classList.remove('hidden');
                codeInput.value = appliedCoupon.code;
                codeInput.classList.add('coupon-applied');
            } else {
                messageEl.classList.add('hidden');
                codeInput.classList.remove('coupon-applied');
            }
        }

        function updateReviewStep() {
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discount = 0;
            let deliveryFee = subtotal >= 500 ? 0 : 40; // Free delivery above â¹500

            if (appliedCoupon) {
                discount = appliedCoupon.discount;
            }

            const total = subtotal - discount + deliveryFee;

            // Update order summary
            let orderSummaryHtml = '<h4 class="font-semibold mb-3">Order Items</h4>';
            cartItems.forEach(item => {
                orderSummaryHtml += `
                    <div class="flex justify-between items-center py-2">
                        <div class="flex items-center gap-3">
                            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded object-cover">
                            <div>
                                <div class="font-medium">${item.name}</div>
                                <div class="text-sm text-gray-600">â¹${item.price} Ã ${item.quantity}</div>
                            </div>
                        </div>
                        <div class="font-semibold">â¹${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
            });
            document.getElementById('order-summary').innerHTML = orderSummaryHtml;

            // Update address summary
            const address = checkoutData.address;
            document.getElementById('address-summary').innerHTML = `
                <div><strong>${address.fullName}</strong></div>
                <div>${address.streetAddress}</div>
                <div>${address.city}, ${address.state} - ${address.pincode}</div>
                <div>Phone: ${address.phoneNumber}</div>
            `;

            // Update payment summary
            document.getElementById('payment-summary').innerHTML = `
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H4.5m2.25 0v3m0 0v.75A.75.75 0 016 10.5h-.75m0 0V9.75c0-.621.504-1.125 1.125-1.125H7.5m0 0v.375c0 .621-.504 1.125-1.125 1.125H6.75m0 0V12m0 0v.75A.75.75 0 016 13.5h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H7.5m0 0V12m0 0v.375c0 .621-.504 1.125-1.125 1.125H6.75m0 0v.75A.75.75 0 006 15h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H7.5" />
                    </svg>
                    <span>Cash on Delivery</span>
                </div>
            `;

            // Update price breakdown
            document.getElementById('review-subtotal').textContent = `â¹${subtotal.toFixed(2)}`;
            document.getElementById('review-delivery').textContent = deliveryFee === 0 ? 'FREE' : `â¹${deliveryFee.toFixed(2)}`;
            document.getElementById('review-total').textContent = `â¹${total.toFixed(2)}`;

            if (discount > 0) {
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('review-discount').textContent = `-â¹${discount.toFixed(2)}`;
            } else {
                document.getElementById('discount-row').style.display = 'none';
            }
        }

        function loadCart() {
            const savedCart = localStorage.getItem('freshmartCart');
            cartItems = savedCart ? JSON.parse(savedCart) : [];
        }

        function saveCart() {
            localStorage.setItem('freshmartCart', JSON.stringify(cartItems));
        }
        
        function updateCart(productId, change) {
            const item = cartItems.find(i => i.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cartItems = cartItems.filter(i => i.id !== productId);
                }
            }
            saveCart();
            renderCart();
        }

        function removeItem(productId) {
            openConfirmationModal('Are you sure you want to remove this item?', () => {
                cartItems = cartItems.filter(i => i.id !== productId);
                saveCart();
                renderCart();
                closeConfirmationModal();
                showToast('Item removed from cart!', 'success');
            });
        }

        function emptyCart() {
            openConfirmationModal('Are you sure you want to empty your cart?', () => {
                cartItems = [];
                saveCart();
                renderCart();
                closeConfirmationModal();
                showToast('Cart emptied successfully!', 'success');
            });
        }

        function setButtonLoading(button, isLoading, originalText) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `
                    <div class="spinner mr-2"></div>
                    <span>Processing...</span>
                `;
            } else {
                button.disabled = false;
                button.innerHTML = `<span>${originalText}</span>`;
            }
        }

        // --- localStorage Order Management ---
        function generateOrderId() {
            return 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        function saveOrderToLocalStorage(orderData) {
            const existingOrders = JSON.parse(localStorage.getItem('freshmartOrders') || '[]');
            existingOrders.unshift(orderData);
            localStorage.setItem('freshmartOrders', JSON.stringify(existingOrders));
            
            // Also save to admin orders
            const adminOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
            adminOrders.unshift(orderData);
            localStorage.setItem('adminOrders', JSON.stringify(adminOrders));
            
            return orderData.id;
        }

        async function proceedToCheckout() {
            console.log('ð Checkout initiated');

            if (!currentUser) {
                console.log('â User not logged in');
                openConfirmationModal('You need to be logged in to place an order. Do you want to go to the login page?', () => {
                    window.location.href = 'login.html';
                    closeConfirmationModal();
                });
                return;
            }

            if (cartItems.length === 0) {
                console.log('â Cart is empty');
                showToast('Your cart is empty. Please add items before checking out.', 'info');
                return;
            }

            openCheckoutModal();
        }

        async function placeOrder() {
            const placeOrderBtn = document.getElementById('place-order-btn');
            setButtonLoading(placeOrderBtn, true, 'Place Order');

            try {
                const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = 0;
                let deliveryFee = subtotal >= 500 ? 0 : 40;

                if (appliedCoupon) {
                    discount = appliedCoupon.discount;
                }

                const total = subtotal - discount + deliveryFee;

                const orderId = generateOrderId();
                const orderData = {
                    id: orderId,
                    userId: currentUser.uid,
                    userName: checkoutData.address.fullName || currentUser.displayName || currentUser.email || 'Guest User',
                    userEmail: currentUser.email || 'No email provided',
                    items: cartItems.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: parseFloat(item.price),
                        quantity: parseInt(item.quantity),
                        image: item.image || 'https://images.pexels.com/photos/1300972/pexels-photo-1300972.jpeg?auto=compress&cs=tinysrgb&w=64&h=64&fit=crop',
                        unit: item.unit || 'unit',
                        subtotal: parseFloat((item.price * item.quantity).toFixed(2))
                    })),
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    discount: parseFloat(discount.toFixed(2)),
                    deliveryFee: parseFloat(deliveryFee.toFixed(2)),
                    totalAmount: parseFloat(total.toFixed(2)),
                    orderDate: new Date().toISOString(),
                    status: 'Pending',
                    paymentMethod: checkoutData.paymentMethod,
                    paymentStatus: checkoutData.paymentMethod === 'cod' ? 'Pending' : 'Paid',
                    deliveryAddress: checkoutData.address,
                    couponApplied: appliedCoupon ? {
                        code: appliedCoupon.code,
                        discount: appliedCoupon.discount,
                        description: appliedCoupon.description
                    } : null,
                    orderNotes: '',
                    estimatedDelivery: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                console.log('ð¦ Order data prepared:', orderData);

                const savedOrderId = saveOrderToLocalStorage(orderData);
                console.log('â Order placed successfully with ID:', savedOrderId);
                
                showToast('ð Order placed successfully!', 'success', 4000);
                showToast('ð§ Order confirmation sent to your email!', 'info', 3000);

                // Clear cart after successful order
                cartItems = [];
                saveCart();
                closeCheckoutModal();
                renderCart();
                
                // Show success message and redirect
                setTimeout(() => {
                    showToast('Redirecting to My Orders...', 'info', 2000);
                    setTimeout(() => {
                        window.location.href = 'my_orders.html';
                    }, 1000);
                }, 2000);

            } catch (error) {
                console.error("â Error placing order:", error);
                showToast(`â Failed to place order: ${error.message}`, 'error', 6000);
            } finally {
                setButtonLoading(placeOrderBtn, false, 'Place Order');
            }
        }

        function renderCart() {
            loadCart();
            mainContent.innerHTML = '';

            if (cartItems.length === 0) {
                mainContent.innerHTML = `
                    <div class="text-center py-12 sm:py-20 px-4">
                        <div class="max-w-md mx-auto">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 sm:w-10 sm:h-10 text-gray-400">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Your cart is empty</h2>
                            <p class="text-gray-500 mb-6">Looks like you haven't added anything to your cart yet.</p>
                            <a href="shop.html" class="inline-block rounded-xl h-12 sm:h-14 px-6 sm:px-8 bg-[#6ec88e] text-[#111813] text-base font-bold tracking-[0.015em] hover:bg-green-500 transition-colors touch-button">
                                Start Shopping
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            let subtotal = 0;
            let cartListHTML = '';

            cartItems.forEach(item => {
                const quantity = typeof item.quantity === 'number' ? item.quantity : 1;
                const itemTotal = item.price * quantity;
                subtotal += itemTotal;
                cartListHTML += `
                    <div class="cart-item flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 border-b py-4 last:border-b-0">
                        <div class="cart-item-info flex items-center gap-4 w-full sm:w-auto">
                            <img src="${item.image || 'https://images.pexels.com/photos/1300972/pexels-photo-1300972.jpeg?auto=compress&cs=tinysrgb&w=64&h=64&fit=crop'}" alt="${item.name}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-md object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-800 text-sm sm:text-base truncate">${item.name}</p>
                                <p class="text-xs sm:text-sm text-gray-500">â¹${item.price.toFixed(2)} / ${item.unit || 'unit'}</p>
                            </div>
                        </div>
                        <div class="cart-item-controls flex items-center justify-between w-full sm:w-auto gap-4">
                            <div class="quantity-controls flex items-center gap-3">
                                <button class="quantity-btn p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center touch-button" data-id="${item.id}" data-change="-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 sm:w-4 sm:h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" /></svg>
                                </button>
                                <span class="w-8 text-center text-gray-800 font-medium text-sm sm:text-base">${quantity}</span>
                                <button class="quantity-btn p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center touch-button" data-id="${item.id}" data-change="1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 sm:w-4 sm:h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                </button>
                            </div>
                            <div class="item-total font-semibold text-gray-800 text-sm sm:text-base min-w-[80px] text-right">â¹${itemTotal.toFixed(2)}</div>
                            <button class="remove-button text-red-500 hover:text-red-700 font-medium transition-colors p-2 touch-button" data-id="${item.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.924a2.25 2.25 0 01-2.244-2.077L4.74 6.75M9 12.75h.008v.008H9v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM12 6.75V15" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            const deliveryFee = subtotal >= 500 ? 0 : 40;
            const grandTotal = subtotal + deliveryFee;

            const cartPageHTML = `
                <div class="max-w-4xl mx-auto py-6 sm:py-10 px-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Your Shopping Cart</h2>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="p-4 sm:p-6">
                            <div id="cart-items-container">
                                ${cartListHTML}
                            </div>
                        </div>
                        <div class="mobile-cart-summary bg-gray-50 sm:bg-transparent">
                            <div class="sm:p-6">
                                <div class="flex flex-col items-end gap-4">
                                    <div class="w-full sm:w-1/2 lg:w-1/3 space-y-2">
                                        <div class="flex justify-between text-base sm:text-lg">
                                            <span class="font-medium text-gray-600">Subtotal:</span>
                                            <span class="font-semibold text-gray-800">â¹${subtotal.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">Delivery Fee:</span>
                                            <span class="text-gray-800">${deliveryFee === 0 ? 'FREE' : 'â¹' + deliveryFee.toFixed(2)}</span>
                                        </div>
                                        ${subtotal < 500 ? `<div class="text-xs text-gray-500">Free delivery on orders above â¹500</div>` : ''}
                                        <div class="flex justify-between text-lg sm:text-xl border-t pt-2">
                                            <span class="font-bold text-gray-800">Grand Total:</span>
                                            <span class="font-bold text-gray-900">â¹${grandTotal.toFixed(2)}</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col sm:flex-row w-full sm:w-auto gap-3 mt-4">
                                        <button id="empty-cart-btn" class="w-full sm:w-auto rounded-xl h-12 px-6 bg-red-100 text-red-700 font-bold hover:bg-red-200 transition-colors touch-button">Empty Cart</button>
                                        <button id="checkout-btn" class="w-full sm:w-auto rounded-xl h-12 px-6 bg-[#6ec88e] text-[#111813] font-bold hover:bg-green-500 transition-colors touch-button">Proceed to Checkout</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            mainContent.innerHTML = cartPageHTML;
            addCartActionListeners();
        }

        function addCartActionListeners() {
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    const change = parseInt(e.currentTarget.dataset.change);
                    updateCart(id, change);
                });
            });

            document.querySelectorAll('.remove-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    removeItem(id);
                });
            });

            document.getElementById('empty-cart-btn')?.addEventListener('click', emptyCart);
            document.getElementById('checkout-btn')?.addEventListener('click', proceedToCheckout);
        }

        // --- Checkout Event Listeners ---
        document.getElementById('close-checkout-modal').addEventListener('click', closeCheckoutModal);

        // Address form
        document.getElementById('address-form').addEventListener('submit', (e) => {
            e.preventDefault();
            checkoutData.address = {
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                streetAddress: document.getElementById('streetAddress').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                pincode: document.getElementById('pincode').value,
                landmark: document.getElementById('landmark').value
            };
            goToStep(2);
        });

        // Coupon application
        document.getElementById('apply-coupon-btn').addEventListener('click', () => {
            const code = document.getElementById('coupon-code').value.trim();
            if (!code) {
                showToast('Please enter a coupon code', 'error');
                return;
            }

            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const result = applyCoupon(code, subtotal);

            if (result.success) {
                appliedCoupon = {
                    code: code.toUpperCase(),
                    discount: result.discount,
                    description: result.coupon.description,
                    message: result.message
                };
                showToast(result.message, 'success');
            } else {
                showToast(result.message, 'error');
            }
            updateCouponDisplay();
        });

        // Coupon card application
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('apply-coupon-card')) {
                const code = e.target.closest('.coupon-card').dataset.code;
                document.getElementById('coupon-code').value = code;
                document.getElementById('apply-coupon-btn').click();
            }
        });

        // Navigation buttons
        document.getElementById('back-to-address').addEventListener('click', () => goToStep(1));
        document.getElementById('continue-to-payment').addEventListener('click', () => goToStep(3));
        document.getElementById('back-to-coupon').addEventListener('click', () => goToStep(2));
        document.getElementById('continue-to-review').addEventListener('click', () => goToStep(4));
        document.getElementById('back-to-payment').addEventListener('click', () => goToStep(3));

        // Payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                if (method.classList.contains('disabled')) return;
                
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                
                const radio = method.querySelector('input[type="radio"]');
                radio.checked = true;
                checkoutData.paymentMethod = radio.value;
            });
        });

        // Place order
        document.getElementById('place-order-btn').addEventListener('click', placeOrder);
        
        // Confirmation Modal Listeners
        confirmBtn.addEventListener('click', () => {
            if(actionToConfirm) {
                actionToConfirm();
            }
        });

        cancelBtn.addEventListener('click', () => {
            closeConfirmationModal();
        });

        // Listen for Firebase Auth state changes
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            console.log('ð Auth state changed:', user ? `Logged in as ${user.email}` : 'Not logged in');
            renderCart();
        });
    });
</script>
</body>
</html>